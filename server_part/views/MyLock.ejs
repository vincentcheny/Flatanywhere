<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!--//永远以最新的IE版本模式来显示网页-->
  <title>MyLock</title>

  <link rel="stylesheet" type="text/css" href="./css/qrcodeDialog.css">
  <style media="screen">
    body{
      font-family: "微软雅黑";
      background-color: #fff;
    }

  </style>
  <link rel="stylesheet" type="text/css" href="./css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style media="screen">
    .card{
      border-radius: 20px;
    }
    .dropdown-item {
      color: black;
      padding: 10px;
      text-decoration: none;
      display: inline-block;
      width: 100%;
      border-radius: 5px;
    }
    .dropdown-item:hover {
      background-color: white;
      cursor: pointer;
    }
    #filter{
      float: right;
      margin-top:-40px;
      margin-bottom: 10px;
    }
    #filter>span>img{
      display: inline;
      margin-right: 10px;
    }
    #filter>span>p{
      display: inline;

    }
    #filter>span{
      margin-right: 10px;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
    }
    #filter>span:hover{
      box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.2);
    }
    #filter>span>img{
      border-radius: 10px;
      border-style: dotted;
    }
    .tabs>li>a:hover{
      cursor: pointer;
      color: dimgrey !important;
    }
    .tabs>li:nth-child(1)>a:hover{
      background-color: white;
    }
    .tabs>li:nth-child(2)>a:hover{
      background-color: rgb(123, 230, 182);
    }
    .tabs>li:nth-child(3)>a:hover{
      background-color: rgb(231, 240, 117);
    }
    .tabs>li:nth-child(4)>a:hover{
      background-color: #90caf9;
      color: white !important;
    }
    .tabs>li:nth-child(5)>a:hover{
      background-color: rgb(191, 191, 191);
      color: white !important;
    }
  </style>
  <script type="text/javascript" src="./js/jquery.min.js"></script>
  <script type="text/javascript" src="./js/base.js"></script>
  <script type="text/javascript" src="./js/web3.min.js"></script>
  <script type="text/javascript" src="./js/materialize.min.js"></script>
  <script type="text/javascript" src="./js/qrcode2.min.js"></script>
  <script type="text/javascript" src="./js/common.js"></script>
  <script type="text/javascript">
    function addLock(type, nickname, num, price, SLID, isShown, st, et) {
      var resource = {
        'icon': ['images/lock_unleased.svg', 'images/lock_rented.svg', 'images/lock_renting.svg', 'images/lock_future.svg'],
        'classType': ['unleasedDiv', 'rentedDiv', 'rentingDiv', 'futureDiv'],
      }

      var $card_image = $('<div><img><span></span></div>');
      $card_image.filter("div").eq(0).attr({
        'class': 'card-image waves-effect waves-block waves-light',
        'style': 'border-radius: 20px'
      });
      $card_image.children("img").attr({
        'class': 'activator',
        'src': resource.icon[type],
      });

      var $card_content = $('<div><span></span><div class="card-action"><span></span><span></span></div></div>');

      $card_content.filter("div").eq(0).attr({
        'class': 'card-content'
      });
      $card_content.find("span").eq(0).attr({
        'class': 'card-title activator grey-text text-darken-4',
      });
      $card_content.find("span").eq(0).html(nickname+'<i class="material-icons right">more_vert</i>');
      $card_content.find("span").eq(1).attr({
        'class': 'left',
        'id': 'priceid'+num,
        'readonly': 'readonly',
      });
      $card_content.find("span").eq(1).html(price+" ETH");
      $card_content.find("span").eq(2).attr({
        'class': 'right'
      });
      if (type < 2 && isShown == true) {
        $card_content.find("span").eq(2).html("On Sale");
      }

      var $card_reveal;
      if (type == 0 || type == 1) {
        // own
        $card_reveal = $('<div><span></span><p></p><a></a><a></a><a></a></div>');
        $card_reveal.find("a").eq(0).attr({
          'onclick': "toggleStore('"+SLID+"', "+isShown+", '"+st+"', '"+et+"',"+num+", '"+nickname+"' )",
          'class': 'dropdown-item hoverable center-align',
        });
        $card_reveal.find("a").eq(0).html(isShown==true?"Discontinue":"Publish");
        $card_reveal.find("a").eq(2).attr({
          'onclick': "deleteLock('"+SLID+"', "+num+")",
          'class': 'dropdown-item hoverable center-align',
          // 'style': 'background-color: red; color: white;'
        });
        $card_reveal.find("a").eq(2).hover(function() {
          $card_reveal.find("a").eq(2).css("background-color","red");
          $card_reveal.find("a").eq(2).css("color","white");
        },function(){
          $card_reveal.find("a").eq(2).css("background-color","rgba(0,0,0,0)");
          $card_reveal.find("a").eq(2).css("color","black");
        });
        $card_reveal.find("a").eq(2).html("DELETE");
      } else if (type == 2) {
        // renting
        $card_reveal = $('<div><span></span><p></p><a></a></div>');
      } else if (type == 3) {
        // booked
        $card_reveal = $('<div><span></span><p></p></div>');
      }
      if (type == 0 || type == 2) {
        // able to control
        var idx = parseInt((2-type)/2);
        $card_reveal.find("a").eq(idx).attr({
          'onclick': 'Unlock("'+SLID+'")',
          'class': 'dropdown-item hoverable center-align',
        });
        $card_reveal.find("a").eq(idx).html("Unlock");
      }
      $card_reveal.filter("div").eq(0).attr({
        'class': 'card-reveal ',
        'id': 'reveal'+num
      });
      $card_reveal.find("span").eq(0).attr({
        'class': 'card-title activator grey-text text-darken-4',
      });
      $card_reveal.find("span").eq(0).html(nickname + "<i class='material-icons right' id='close"+num+"'>close</i>");
      $card_reveal.find("p").eq(0).html("Placeholder");

      var $newLockCard = $('<div><div class="card hoverable"></div></div>');
      $newLockCard.filter("div").eq(0).attr({
        'id': 'lock'+num,
        'class': 'col s6 m4 l3 lock-item ' + resource.classType[type]
      });
      $newLockCard.children("div").append($card_image).append($card_content).append($card_reveal);
      $("#lock-list").append($newLockCard);
    }
    function dateFormat(time, addDay){
      time = new Date(time.getTime() + 24*60*60*1000*addDay);
      //格式化日，如果小于9，前面补0
      var day = ("0" + time.getDate()).slice(-2);
      //格式化月，如果小于9，前面补0
      var month = ("0" + (time.getMonth() + 1)).slice(-2);
      //拼装完整日期格式
      var date = time.getFullYear()+"-"+(month)+"-"+(day) ;
      return date;
    }
    function toggleStore(SLID, isOnStore, st, et, num, nickname){
      // $('#self_store').val(sessionStorage.userAccount);
      $('#SLIDid_store').val(SLID);
      if (isOnStore==false) { // Currently not in store and want to publish
        $("#nicknameid")[0].value = nickname;
        Materialize.updateTextFields();
        $("#newDate").removeClass("hide");
        $("#submitRow button[name='bind']").attr({
          'onclick': 'newDateSubmit('+num+", '"+nickname+"', '"+SLID+"' )",
        });
        $(".lock-item, .activator").css({'pointer-events': 'none'});
        if (st != ''){ // There is a future deal for the flat
          // if resetting the end_time, it has to be later than the origin one 'cause there is a future deal
          $("#submitRow").find("div").eq(0).removeClass("m6");
          $("#submitRow").find("div").eq(0).addClass("m3");
          $("#submitRow").find("div").eq(3).removeClass("hide");
          $("#submitRow button[name='reset']").attr({
            'onclick': 'resetNewDateSubmit('+num+", '"+nickname+"', '"+st+"', '"+et+"', '"+SLID+"' )",
          });
        }
      } else { // Currently in store and want to discontinue
        if (st == '') {
          alert("Error: Try to hide(Already in store) but start_time undefined!");
        } else {
          // 不能早于当前最后的一个 deal 的 check_out_time
          if (JSON.parse(sessionStorage.getItem(SLID)) == null) {
            // 没有待完成的 Deal
            $("#stid").val("");
            $("#etid").val("");
          } else {
            // 有待完成的 Deal
            $("#stid").val(dateFormat(new Date(), 0));
            $("#etid").val(dateFormat(new Date(JSON.parse(sessionStorage.getItem(SLID))), 0));
          }
          $('#hsid_store').val(4);
          sendAJAX("text", num, false, SLID, st, et, nickname, false);
        }
      }
    }
    function sendAJAX(datatype, num, isPublish, SLID, st, et, nickname, clearReset) {
      $.ajax({
         type: "POST",//方法类型
         dataType: datatype,//预期服务器返回的数据类型
         async: false,
         data: $('form').serialize(),
         success: function (result) {
           var currentState = isPublish ? "Publish" : "Discontinue";
           var newState = isPublish ? "Discontinue" : "Publish";
           Materialize.toast(currentState + " Successfully!", 4000);
           $("#reveal"+num).find("a").eq(0).attr({
             'onclick': "toggleStore('"+SLID+"', "+isPublish+", '"+st+"', '"+et+"',"+num+", '"+nickname+"' )",
           });
           $("#reveal"+num).find("a").eq(0).html(newState);
           $("#newDate").addClass("hide");
           $("#close"+num).click();
           $("#stid").val("");
           $("#etid").val("");
           if (clearReset) {
             $("#submitRow").find("div").eq(0).addClass("m6");
             $("#submitRow").find("div").eq(3).addClass("hide");
           }
         },
         error : function() {
             alert("Error in AJAX!");
         }
       });
    }
    function deleteLock(SLID, num) {
      $.ajax({
        type: "POST",//方法类型
        dataType: "JSON",//预期服务器返回的数据类型
        url: "/RemovalQuery" ,//url
        async: false,
        data: {'SLID':SLID},
        success: function (result) {
          console.log(result[0].count);
          if (result[0].count > 0) {
            Materialize.toast(SLID.substring(0,7)+"... is being booked. Cannot delete.", 5000);
          } else {
            $.ajax({
              type: "POST",//方法类型
              dataType: "text",//预期服务器返回的数据类型
              url: "/Removal" ,//url
              async: false,
              data: {'SLID':SLID},
              success: function (result) {
                if (result != '0') {
                  console.log("Abnormal ajax POST response:", result);
                } else {
                  Materialize.toast("You delete "+SLID.substring(0,7)+"...", 5000);
                  $("#lock"+num).fadeOut(500);
                  setTimeout(function() {
                    $("#lock"+num).remove();
                  }, 500);
                }
              },
              error : function() {
                alert("Error in AJAX!");
              }
            });
          }
        },
        error : function() {
          alert("Error in AJAX!");
        }
      });

    }
    function cencelNewDateSubmit() {
      $("#stid").val("");
      $("#etid").val("");
      $("#newDate").addClass("hide");
      $(".lock-item, .activator").css({'pointer-events': 'auto'});
    }
    function resetNewDateSubmit(num, nickname, st, et, SLID){
      $('#stid').val(dateFormat(st, 0));
      $('#etid').val(dateFormat(et, 0));
      $('#hsid_store').val(3);
      $(".lock-item, .activator").css({'pointer-events': 'auto'});
      sendAJAX("text", num, true, SLID, st, et, nickname, true);
    }
    function newDateSubmit(num, nickname, SLID) {
      var stdate = new Date($('#stid').val());
      var eddate = new Date($('#etid').val());
      if (stdate == "Invalid Date" || eddate == "Invalid Date") {
        alert("Lack of start date or end date!");
        return ;
      } else if (stdate >= eddate) {
        alert("Start date should be greater than end date!");
        return ;
      }
      $('#stid').val(dateFormat(stdate, 0));
      $('#etid').val(dateFormat(eddate, 0));
      $('#hsid_store').val(3);
      sendAJAX("text", num, true, SLID, stdate, eddate, nickname, false);
    }
    function Unlock(SLID){
      $("#qrimg").empty();
      $("body").append("<div id='mask'></div>");
      $("#mask").addClass("mask").fadeIn("slow");
      $("#LoginBox").fadeIn("slow");
      var qrcode = new QRCode2.default($("#qrimg")[0], {
            width: 200,
            height: 200
          });
      qrcode.clear();
      qrcode.makeCode(SLID);
      $("html,body").animate({scrollTop:0},500);
      return ;
      Flatanywhere.unlock.sendTransaction(sessionStorage.userAccount, {from: sessionStorage.userAccount}, function(err, result){
        if (!err) {
          console.log("Unlock Successfully!");
        } else {
          console.error(err);
        }
      });
    }
    function showType(className){
      $(".lock-item").not(className).fadeOut(500);
      setTimeout(function(){
        $(".lock-item").not(className).addClass("hide");
        $(".lock-item"+className).fadeIn(500);
        $(".lock-item"+className).removeClass("hide");
      }, 500);
    }
    function selectType(num){
      if (num == 0) {
        showType(".unleasedDiv");
      } else if (num == 1) {
        showType(".rentedDiv");
      } else if (num == 2) {
        showType(".rentingDiv");
      } else if (num == 3) {
        showType(".futureDiv");
      } else {
        // show ALL
        $(".lock-item").fadeOut(500);
        setTimeout(function(){
          $(".lock-item").removeClass("hide");
          $(".lock-item").fadeIn(500);
        }, 500);
      }
    }
    $(document).ready(function(){
      $('#userAccount').val(sessionStorage.userAccount);
      $(".dropdown-button").dropdown();
      $(".button-collapse").sideNav();
      $('.datepicker').pickadate({
        selectMonths: true, // Creates a dropdown to control month
        selectYears: 4 // Creates a dropdown of 15 years to control year
      });
      sessionStorage.newDealCount = 0;
      setInterval(function(){
        $.ajax({
         //几个参数需要注意一下
             type: "GET",//方法类型
             dataType: "json",//预期服务器返回的数据类型
             url: "/Query" ,//url
             async: false,
             success: function (result) {
               if (result[0].count != 0) {
                 Materialize.toast("You receive "+result[0].count+" new deals!", 5000);
                 $.ajax({
                      type: "POST",//方法类型
                      dataType: "text",//预期服务器返回的数据类型
                      url: "/Query" ,//url
                      async: false,
                      success: function (result) {
                        if (result != '0') {
                          console.log("Abnormal ajax POST response:", result);
                        }
                      },
                      error : function() {
                          alert("Error in ajax POST!");
                      }
                  });
               }
             },
             error : function() {
                 alert("Error in ajax GET!");
             }
         });
      }, 3000);
  		//关闭二维码
  		$(".close_btn").hover(function () {
        $(this).css({ color: 'black' })
      }, function () {
        $(this).css({ color: '#999' })
      }).on('click', function () {
  			$("#LoginBox").fadeOut("fast");
  			$("#mask").css({ display: 'none' });
  		});
      '<%for (var key in LastDeal) {%>'
        sessionStorage.setItem('<%=key%>', JSON.stringify('<%=LastDeal[key]%>'));
      '<%}%>'
    });
  </script>
</head>

<body>

  <!-- Dropdown Structure -->
  <ul id="dropdown-contact" class="dropdown-content">
    <li><a href="mailto:1155107972@link.cuhk.edu.hk">WU ZhuoMing</a></li>
    <li class="divider"></li>
    <li><a href="mailto:1155107977@link.cuhk.edu.hk">CHEN Yu</a></li>
  </ul>
  <ul id="dropdown-profile" class="dropdown-content">
    <li><a href="javascript:void(0)" onclick="alert(sessionStorage.userAccount)"><br>UserAccount<br><br></a></li>
  </ul>
  <!-- Navbar -->
  <nav>
    <div class="nav-wrapper">
      <a href="/" class="brand-logo">&nbsp;Flatanywhere</a>
      <a href="javascript:void(0)" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li><a href="javascript:void(0)" class="tooltipped" data-position="bottom" data-delay="50" data-tooltip="Your account balance"><span id="balanceid"></span>&nbsp;ETH</a></li>
        <li><a href="/BindLock" class="dropdown-button tooltipped" data-position="bottom" data-delay="50" data-tooltip="Bind A New Lock">Bind</a></li>
        <li><a href="/Store" class="dropdown-button tooltipped" data-position="bottom" data-delay="50" data-tooltip="Explore Your Favourite Flat">Store</a></li>
        <li><a class="dropdown-button tooltipped" href="javascript:void(0)" data-position="bottom" data-delay="50" data-tooltip="Developers' Emails" data-activates="dropdown-contact">Contact<i class="material-icons right">arrow_drop_down</i></a></li>
        <li><a class="dropdown-button tooltipped" href="javascript:void(0)" data-position="bottom" data-delay="50" data-tooltip="Your Account Number" data-activates="dropdown-profile">Profile<i class="material-icons right">arrow_drop_down</i></a></li>
      </ul>
      <ul class="side-nav" id="mobile-demo">
        <li><a href="/BindLock">BindLock</a></li>
        <li><a href="/Store">Store</a></li>
        <li><a href="mailto:1155107972@link.cuhk.edu.hk">Email to: WU ZhuoMing</a></li>
        <li><a href="mailto:1155107977@link.cuhk.edu.hk">Email to: CHEN Yu</a></li>
        <li><a href="javascript:void(0)" onclick="alert(sessionStorage.userAccount)">UserAccount</a></li>
      </ul>
    </div>
  </nav>
  <!--------------------------------------------------------------------------------------------------------->
  <!-- Body Part -->
  <div style="margin-top:30px;">
  </div>

  <div id="LoginBox">
      <div class="row1">
          Unlock Code<a href="javascript:void(0)" title="关闭窗口" class="close_btn" id="closeBtn">×</a>
      </div>
      <div class="row" id="qrimg"></div>
  </div>
  <form accept-charset="UTF-8" method="post">
    <div class="hide container" id="newDate">
      <div class="row">
        <div class="card-panel center-align ">
          <span class="red-text text-darken-5">Please assign a valid time period for the published lock.</span>
        </div>
      </div>
      <div class="row">
        <div class="input-field col s12 m6">
          <i class="material-icons prefix">date_range</i>
          <input id="stid" type="date" name="stname" class="datepicker">
          <label for="stid">Available Since</label>
        </div>
        <div class="input-field col s12 m6">
          <i class="material-icons prefix">date_range</i>
          <label for="etid">Available Until</label>
          <input id="etid" type="date" name="etname" class="datepicker">
        </div>
      </div>
      <div class="row" id="submitRow">
        <div class="input-field col s12 m6">
          <i class="material-icons prefix">location_on</i>
          <input disabled id="nicknameid" name="nickname" type="text">
          <label for="nicknameid">Address</label>
        </div>
        <div class="col s3">
          <button class="btn-large waves-effect waves-light right red" type="button" onclick="cencelNewDateSubmit()" name="cancel">CANCEL
            <i class="material-icons right">cancel</i>
          </button>
        </div>
        <div class="col s3">
          <button class="btn-large waves-effect waves-light right tooltipped" type="button" name="bind" data-position="bottom" data-delay="50" data-tooltip="Bind a New Time and Publish">&nbsp;BIND&nbsp;
            <i class="material-icons right">link</i>
          </button>
        </div>
        <div class="col s3 hide">
          <button class="btn-large waves-effect waves-light right tooltipped" type="button" name="reset" data-position="bottom" data-delay="50" data-tooltip="Simply Publish">PUBLISH
            <i class="material-icons right">link</i>
          </button>
        </div>
      </div>
      <div class="row">

      </div>
    </div>

    <div class="hide">
      <input id="SLIDid_store" name="SLIDname" type="text" required>
      <input id="hsid_store" name="hidden_state" type="text" required>
      <input id="userAccount_store" type="text" name="userAccount" required>
    </div>
  </form>

  <script type="text/javascript">
    sessionStorage.numOfLocks = '<%=Ownerlock.length + Userlock.length%>';
  </script>
  <div class="container">
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s2 hoverable"><a class="active" onclick="selectType()">All</a></li>
          <li class="tab col s2 hoverable"><a onclick="selectType(0)">Unleased</a></li>
          <li class="tab col s3 hoverable"><a onclick="selectType(1)">Being Rented</a></li>
          <li class="tab col s2 hoverable"><a onclick="selectType(2)">Renting</a></li>
          <li class="tab col s2 hoverable"><a onclick="selectType(3)">Booked</a></li>
        </ul>
      </div>
    </div>
    <div id="lock-list" class="row" >
      <% for(var i = 0; i < Ownerlock.length; ++i){ var res = Ownerlock[i]; %>
        <%if(res.currentuser == locals.userAccount){%>
          <script type="text/javascript">
            addLock(0, "<%=res.nickname%>", <%=i%>, "<%=res.unit_price%>", "<%=res.SLID%>", "<%=res.isShown%>", "<%=res.start_time%>", "<%=res.end_time%>");
          </script>
        <%} else {%>
          <script type="text/javascript">
            addLock(1, "<%=res.nickname%>", <%=i%>, "<%=res.unit_price%>", "<%=res.SLID%>", "<%=res.isShown%>", "<%=res.start_time%>", "<%=res.end_time%>");
          </script>
        <%}%>
      <%}%>
      <% for(var i = Ownerlock.length; i < Ownerlock.length + Userlock.length; ++i){ var res = Userlock[i - Ownerlock.length]; %>
        <script type="text/javascript">
          addLock(2, "<%=res.nickname%>", <%=i%>, "<%=res.unit_price%>", "<%=res.SLID%>");
        </script>
      <%}%>
      <% for(var i = Ownerlock.length + Userlock.length; i < Ownerlock.length + Userlock.length + Futurelock.length; ++i){ var res = Futurelock[i - Ownerlock.length - Userlock.length]; %>
        <script type="text/javascript">
          addLock(3, "<%=res.nickname%>", <%=i%>, "<%=res.unit_price%>");
        </script>
      <%}%>
    </div>
  </div>
  <br><br><br>
</body>
</html>
